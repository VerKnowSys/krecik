#!/bin/sh
# blame: @dmilith
# 2019-01-29-1540-1548772806


clear

_params="${*}"

_command="/usr/bin/command"
_uname="$(uname 2>/dev/null)"
_cargo_project_dir="$(pwd 2>/dev/null)"
_release_type="${1:-release}"
_project_name="TravMole"
_bin_name="travmole"
_travmole_webapi_endpoint="127.0.0.1:60666"
_travmole_dest_bin="/usr/bin/${_bin_name}"
_travmole_logfile="logs/travmole.log"
_travmole_supervisor_pidfile="logs/travmole.pid"
_bin_product_target="target/${_release_type}/${_bin_name}"
_curl_software="/Software/Curl_lib"

_cargo_release_flag="--release"
if [ "release" != "${_release_type}" ]; then
    unset _cargo_release_flag
fi


failure () {
    printf "FAILURE: %b\n" "${@}"
    exit 1
}


# used Shared Libraries
case "${_uname}" in
    Darwin|FreeBSD)
        export LD_LIBRARY_PATH="${_curl_software}/lib"
        export OPENSSL_LIB_DIR="${_curl_software}/lib"
        export X86_64_APPLE_DARWIN_OPENSSL_LIB_DIR="${OPENSSL_LIB_DIR}"
        export OPENSSL_INCLUDE_DIR="${_curl_software}/include"
        export X86_64_APPLE_DARWIN_OPENSSL_INCLUDE_DIR="${OPENSSL_INCLUDE_DIR}"
        export OPENSSL_DIR="${_curl_software}"
        export X86_64_APPLE_DARWIN_OPENSSL_DIR="${OPENSSL_DIR}"
        export PKG_CONFIG_PATH="${_curl_software}/lib/pkgconfig"
        ;;

    *)
        _curl_software="/usr/lib"
        ;;
esac


# Sanity checksâ€¦
if [ -x "${_curl_software}/bin/curl-config" ] \
|| [ -x "/usr/bin/curl-config" ]
then
    printf "Curl: OK\n"
else
    failure "Unavailable Curl >= 7.64.0"
fi

if [ ! -x "$(${_command} -v rustc)" ] \
|| [ ! -x "$(${_command} -v cargo)" ]
then
    failure "Unavailable Rust >= 1.32.0"
fi

if [ ! -x "$(${_command} -v jq)" ]
then
    failure "Unavailable utility: Jq >= 1.5"
fi

if [ ! -x "$(${_command} -v grep)" ] \
|| [ ! -x "$(${_command} -v awk)" ] \
|| [ ! -x "$(${_command} -v head)" ] \
|| [ ! -x "$(${_command} -v seq)" ]
then
    failure "Unavailable base system utilities?!"
fi
